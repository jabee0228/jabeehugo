---
date: '2024-12-26T11:41:33+08:00'
# draft: true
draft: false
title: 'DDPM paper notes'
# lastmod: 2024-12-26

tags: ["ç§‘æŠ€", "Diffusion Model", "å­¸ç¿’"]
author: "Jabeeå§œ"

showToc: true
TocOpen: true
hidemeta: false
comments: false
description: ""
disableHLJS: true # to disable highlightjs
disableShare: false
disableHLJS: false
hideSummary: false
searchHidden: false
ShowReadingTime: true
ShowBreadCrumbs: true
ShowPostNavLinks: true
ShowWordCount: true
ShowRssButtonInSectionTermList: true
UseHugoToc: false

cover:
  image: /images/cover.jpg
  caption:

# {{< figure src="/images/cover.jpg" caption="æ¨™é¡Œ" height="400">}}
# {{<video src="IMG_5251.mov" height="400">}}

# {{< galleries >}}
# {{< gallery src="cover.png" >}}
# {{< gallery src="cover.png" >}}
# {{< /galleries >}}
---

é€™ç¯‡ä¸»è¦æ˜¯åƒè€ƒææ•™æˆçš„å½±ç‰‡ï¼Œä»¥åŠç¶²è·¯ä¸Šçš„æ–‡ç« ï¼Œæ•´ç†çš„ç­†è¨˜ã€‚

# Algorithm 1: Training

![image.png](DDPM/image.png)

### **ç¬¬ 1 è¡Œï¼š`repeat`**

- **ä½œç”¨ï¼š** é–‹å§‹ä¸€å€‹è¿­ä»£è¨“ç·´éç¨‹ï¼Œç›´åˆ°æ¨¡å‹æ”¶æ–‚

---

### **ç¬¬ 2 è¡Œ**

- **ä½œç”¨ï¼š** å¾æ•¸æ“šåˆ†ä½ˆ ä¸­å–ä¸€å€‹æ¨£æœ¬ (x0)ï¼ˆå³å¾è¨“ç·´æ•¸æ“šé›†ä¸­æŠ½å–ä¸€å€‹æ•¸æ“šé»ï¼‰ã€‚
    - **x0 ä»£è¡¨ clean Image**ã€‚
    - **q(x0)ï¼š** æ•¸æ“šåˆ†ä½ˆï¼Œå³è¨“ç·´é›†ä¸­æ•¸æ“šçš„çœŸå¯¦åˆ†ä½ˆã€‚

---

### **ç¬¬ 3 è¡Œ**

- **ä½œç”¨ï¼š** éš¨æ©Ÿé¸æ“‡ä¸€å€‹æ™‚é–“tã€‚

---

### **ç¬¬ 4 è¡Œ**

- **ä½œç”¨ï¼š** å–ä¸€å€‹éš¨æ©Ÿå™ªè²æ¨£æœ¬ ã€‚
    - **è§£é‡‹ï¼š**
        - æ“´æ•£éç¨‹ä¸­ï¼Œæ•¸æ“šæœƒé€æ­¥è¢«åŠ ä¸Šå™ªè²ï¼Œæœ€çµ‚è®Šæˆå®Œå…¨éš¨æ©Ÿçš„é«˜æ–¯å™ªè²ã€‚
        - åœ¨è¨“ç·´éç¨‹ä¸­ï¼Œéœ€è¦ç”¨éš¨æ©Ÿå™ªè²æ¨¡æ“¬é€™å€‹æ“´æ•£éç¨‹ã€‚

---

### **ç¬¬ 5 è¡Œï¼šæ¢¯åº¦ä¸‹é™æ›´æ–°**

```
âˆ‡_Î¸ â€–Îµ âˆ’ Îµ_Î¸(âˆšÎ±Ì„_t x_0 + âˆš(1âˆ’Î±Ì„_t) Îµ, t)â€–Â²
```

- **ç´°ç¯€è§£é‡‹ï¼š**
    - Îµ ç‚ºåŸå§‹å™ªè²
    - **Îµ_Î¸(âˆšÎ±Ì„_t x_0 + âˆš(1âˆ’Î±Ì„_t) Îµ, t) é€™ä¸€æ®µåšçš„å‰‡æ˜¯ noise predictorã€‚**
    - è€Œ noise predictor æœƒæœ‰ä»¥ä¸‹å…©å€‹ input

        **input 1. âˆšÎ±Ì„_t x_0 + âˆš(1âˆ’Î±Ì„_t) Îµ ; input 2. t ä»£è¡¨ç¬¬å¹¾å€‹å›åˆçš„ å›åˆè¶Šå¾Œé¢ï¼ŒåŠ ä¸Šçš„å™ªè²è¶Šå¤šã€‚**

        ![image.png](DDPM/image1.png)

    - **âˆšÎ±Ì„_t x_0 + âˆš(1âˆ’Î±Ì„_t) Îµ ï¼šé€™é‚Š Î±Ì„_t æ˜¯æ ¹æ“š Unuiform å‡ºä¾†çš„ t ï¼Œå¦‚æœ t å€¼è¶Šå¤§ï¼ŒÎ±Ì„_t è¶Šå°ã€‚ Î±Ì„_t è¶Šå°ï¼Œä»£è¡¨åŠ ä¸Šçš„å™ªè²æ¯”ä¾‹å‰‡è¶Šå¤šï¼ˆå³é‚Šä¹˜ä¸Šçš„âˆš(1âˆ’Î±Ì„_t)ï¼‰ã€‚**
    - **ç›®æ¨™ï¼š** æœ€å°åŒ– ï¼Œå³è®“æ¨¡å‹è¼¸å‡ºçš„å™ªè²èˆ‡å¯¦éš›åŠ å…¥çš„å™ªè²è¶Šæ¥è¿‘è¶Šå¥½ã€‚
    - **æ¢¯åº¦ä¸‹é™ï¼š** å°æ¨¡å‹çš„æå¤±å‡½æ•¸é€²è¡Œæ¢¯åº¦ä¸‹é™ï¼Œæ›´æ–°åƒæ•¸ ã€‚åˆ©ç”¨ MSE å¹³å‡å¹³æ–¹å·®æå¤±å»ç®— æ¢¯åº¦ä¸‹é™ç‡ã€‚

---

### **ç¬¬ 6 è¡Œï¼š`until converged`**

- **ä½œç”¨ï¼š** æŒçºŒè¿­ä»£ï¼Œç›´åˆ°æ¨¡å‹è¨“ç·´æ”¶æ–‚ã€‚

---

# Algorithm 2: Sampling

![image.png](DDPM/image2.png)

### **ç¬¬ä¸€è¡Œ çµ¦è¨‚ä¸€å€‹ X å¤§ T ç´”é›œè¨Šåœ–**

- **æ„ç¾©**ï¼šå¾æ¨™æº–é«˜æ–¯åˆ†ä½ˆï¼ˆå‡å€¼ç‚º 0ï¼Œæ–¹å·®ç‚º 1ï¼‰ä¸­éš¨æ©Ÿç”Ÿæˆä¸€å€‹å™ªè²æ¨£æœ¬ä½œç‚ºèµ·å§‹é»ã€‚
- X å¤§ T ä»£è¡¨çš„æ˜¯ **ç´”é›œè¨Šåœ–**

---

### **ç¬¬äºŒè¡Œ è¿´åœˆé–‹å§‹**

å¾ç´”å™ªè²ä¸€è·¯ Sampling åˆ° ç”Ÿæˆåœ–

- **æ„ç¾©**ï¼šå¾æ™‚é–“tï¼ˆæœ€ç´”çš„å™ªè²ï¼‰é–‹å§‹ï¼Œé€æ­¥å›æº¯åˆ° ï¼ˆé€æ¼¸å»å™ªç›´åˆ°é‚„åŸå‡ºæ¸…æ™°çš„æ•¸æ“šï¼‰ã€‚

---

### **ç¬¬ä¸‰è¡Œ å™ªè²æ¢ä»¶**

- **æ„ç¾©**ï¼šåœ¨ Sampling éšæ®µï¼Œæœƒåœ¨åšå®Œæ¸›å» Noise predictor å¾Œï¼Œå†åŠ ä¸Š z å™ªè²ï¼ˆè«‹çœ‹ç¬¬å››è¡Œï¼‰
    - ä½†åœ¨ t == 0 æ™‚ï¼Œå·²ç¶“å®Œæˆ Sampling ï¼Œå› æ­¤ä¸å†åŠ ä¸Š z ã€‚

---

### **ç¬¬å››è¡Œ**

![image.png](DDPM/image3.png)

x_{t-1} = (1 / âˆš(a_t)) * (x_t - (1 - a_t) / âˆš(1 - Î±Ì„_t) * ÏµÎ¸(x_t, t)) + Ïƒ_t * z

**è©³è¦‹ï¼šSampling éšæ®µ Denoise function åŒ–ç°¡**

- **åˆ†è§£ç†è§£**ï¼š
    1. ÏµÎ¸(x_t, t)ï¼šNoise predicotr æ ¹æ“šç•¶å‰ t (å“ªä¸€éšæ®µ) ç”Ÿæˆå™ªè²
    2. (x_t - (1 - a_t) / âˆš(1 - Î±Ì„_t) * ÏµÎ¸(x_t, t)ï¼šå¾ç•¶å‰æ•¸æ“šä¸­æ¸›å»é æ¸¬çš„å™ªè²éƒ¨åˆ†ã€‚
        1. x_t ä»£è¡¨çš„å‰‡æ˜¯ä¸Šä¸€éšæ®µçš„çµæœï¼Œå› æ­¤ = å³é‚Šæ˜¯x_{t-1} ï¼Œä¹Ÿå°±æ˜¯é€æ­¥ Sample åˆ° x0 ï¼ˆclean imageï¼‰ã€‚
    3. (1 / âˆš(a_t))ï¼šï¼ˆä¹˜è™Ÿå·¦é‚Šï¼‰èª¿æ•´ä¿¡è™Ÿå¹…åº¦ï¼Œä½¿å…¶å›åˆ°æ­£ç¢ºçš„åˆ†ä½ˆç¯„åœã€‚
    4. + Ïƒ_t * zï¼šæ·»åŠ éš¨æ©Ÿå™ªè² ï¼Œ**æ¨¡æ“¬åå‘éç¨‹çš„éš¨æ©Ÿæ€§**ã€‚
- **ç›®çš„**ï¼šå¾ç•¶å‰çš„té‚„åŸåˆ°ä¸Šä¸€å€‹t ã€‚

![image.png](DDPM/image4.png)

---

### **ç¬¬äº”è¡Œ è¿´åœˆçµæŸ**

---

### **ç¬¬å…­è¡Œ æœ€çµ‚è¼¸å‡º**

- **æ„ç¾©**ï¼šç•¶è¿´åœˆçµæŸæ™‚ï¼Œè¼¸å‡ºæœ€å¾Œçš„çµæœ ï¼Œé€™å°±æ˜¯é‚„åŸå‡ºçš„æ¸…æ™°æ•¸æ“šï¼ˆå¦‚åœ–åƒï¼‰ã€‚
    - x0 ä»£è¡¨ clean imageï¼Œå› æ­¤ return x0ã€‚

---

# Maximum Likelihood Estimation

![image.png](DDPM/image5.png)

MLE çš„ç›®çš„æ˜¯ç‚ºäº†è®“ PÎ¸ ç›¡å¯èƒ½çš„æ¥è¿‘æ–¼ Pdataã€‚

- PÎ¸(x)ï¼šmodel æ‰€ sample å‡ºçš„ distribution æ©Ÿç‡ã€‚
- Pdata(x) : çœŸå¯¦ä¸–ç•Œçš„ datasetï¼Œå’Œ model çš„ network ç„¡é—œã€‚

![image.png](DDPM/image6.png)

å°‡æ¯ä¸€å€‹ sample å‡ºä¾†çš„ xi æ‹¿ pÎ¸ ç®—å‡ºæ©Ÿç‡ ä¸¦ç›¸ä¹˜ï¼Œç«Ÿå¯èƒ½æ‰¾å‡ºæœ€å¤§ Î¸ã€‚

æ‰€ä»¥æˆ‘å€‘è¦æ‰¾çš„ Î¸ å°±æ˜¯æ©Ÿç‡æœ€é«˜çš„é‚£ä¸€å€‹ï¼ˆLHY åœ¨æŠ•å½±ç‰‡ç”¨ Î¸* ä»£è¡¨ï¼‰ã€‚

> network çš„ç›®æ¨™æ˜¯å­¸ç¿’æ•¸æ“šçš„è¦å¾‹ï¼ˆçœŸå¯¦åˆ†ä½ˆğ‘(ğ‘¥0)q(x0)ï¼‰ï¼Œç„¶å¾Œæ¨¡æ“¬é€™äº›æ•¸æ“šçš„æ©Ÿç‡ï¼Œé€™å°±æ˜¯ğ‘ğœƒ(ğ‘¥0)pÎ¸(x0)ã€‚å®ƒä»£è¡¨æ¨¡å‹èªç‚ºæ•¸æ“šğ‘¥0x0æœ‰å¤šã€Œåˆç†ã€æˆ–ã€Œå¯èƒ½ã€ã€‚
*from chatgpt
>

![image.png](DDPM/image7.png)

å¾log ç›¸ä¹˜è½‰æ›æˆ ç›¸åŠ log ï¼Œç›¸åŠ  log é€™æ¨£æœƒè¿‘ä¼¼æ–¼ å¾ pdata å–å‡ºçš„ x ï¼Œç„¶å¾Œ pÎ¸ ç®—å‡ºæ©Ÿç‡ è¦è¶Šå¤§è¶Šå¥½ã€‚

![image.png](DDPM/image8.png)

æ¥è‘—å¾ expectation è½‰æ›ç‚ºç©åˆ†ï¼Œç„¶å¾Œå¯ä»¥ç®—å‡ºå°±ç­‰åŒæ–¼ KL(Pdata||PÎ¸) ï¼Œæ‰€ä»¥æˆ‘å€‘è¦æ‰¾ minimun KLã€‚

è®“ ptheta è®“ pdataçš„å·®ç•°æœ€å°ã€‚

# VAE: Compute pÎ¸

![image.png](DDPM/image9.png)

é€™é‚Šä¸»è¦æ˜¯åœ¨è¬›èªªï¼Œå› ç‚ºæˆ‘å€‘ä¸å¯èƒ½å»ç›´æ¥çœ‹ pÎ¸(x|z) ï¼Œå› ç‚ºä¸å¯èƒ½ sample å‡ºå®Œå…¨ä¸€æ¨¡ä¸€æ¨£çš„åœ–ï¼Œé€™æ¨£æœƒé€ æˆ pÎ¸(x|z) = 0ã€‚

å› æ­¤æˆ‘å€‘æ˜¯å»çœ‹ Mean of Gaussian (å»çœ‹è·é›¢ï¼Œä¹Ÿå°±æ˜¯ x å’Œ G(z)çš„è·é›¢)ã€‚

# VAE: Lower bound of

![image.png](DDPM/image10.png)

- â‰¥ 0 æ˜¯å› ç‚º å®ƒå¯ä»¥çœ‹ä½œ KL divergence è€Œå®Œå…¨ä¸€æ¨£å°±ç‚º0ï¼Œå› æ­¤ â‰¥ 0ã€‚

# DDPM: Compute  pÎ¸(x)

![image.png](DDPM/image11.png)

![image.png](DDPM/image12.png)

åœ¨ç®— DDPM æ™‚ï¼Œå’Œ VAE ä¸åŒçš„æ˜¯ï¼Œ Maximize æœŸæœ›å€¼æ™‚ï¼ŒåŸå…ˆçš„ Encoder æ›¿æ›æˆ Diffusion Processï¼Œä¹Ÿå°±æ˜¯åœ¨åŠ  Noise çš„é‚£å€‹éšæ®µã€‚

å°‡å¼å­å±•é–‹å¾Œç‚ºä»¥ä¸‹ã€‚

![image.png](DDPM/image13.png)

å¾ x1 ä¸€ç›´åšåˆ° X å¤§ T

# å–®å€‹ q(XT | XT-1) ç®—æ³•

æˆ‘å€‘é¦–å…ˆè¦å…ˆå®šç¾©ä¸€çµ„ **Î²1 ~ Î²T** ï¼Œé€™çµ„æ•¸å€¼ç‚ºè‡ªå®šç¾©çš„ï¼Œé¡ä¼¼ Learning rateï¼Œæœƒæ ¹æ“šä¿®æ”¹å½±éŸ¿ Networkã€‚ å› ç‚ºé€™æœƒå½±éŸ¿åœ¨æ¯ä¸€ t åŠ ä¸Šçš„å™ªè²

ï¼ˆä»¥ä¸‹ææ•™æˆæœ‰ç­†èª¤ï¼Œæ‡‰ç‚º Xt = âˆš1-Bt * Xt-1 + âˆšBt * noiseï¼‰

![image.png](DDPM/image14.png)

# å¦‚æœè¦ç®—å‡º q(XT | X0)

å…¶å¯¦æ˜¯å¯ä»¥ä¸ç”¨ä¸€æ¬¡ä¸€æ¬¡å»æŠŠå®ƒç®—å‡ºä¾†ï¼ˆä¸ç”¨ä¸€æ­¥ä¸€æ­¥æŠŠå®ƒ+ä¸Šå™ªè²ï¼‰ã€‚

å¾ä¸‹æ–¹å¯ä»¥æ¨å°å‡º q(X2 | X0)

![image.png](DDPM/image15.png)

![image.png](DDPM/image16.png)

![image.png](DDPM/image17.png)

![image.png](DDPM/image18.png)

å› æ­¤ q(Xt | X0) å°±å¯ä»¥æ•´ç†æˆä¸Šåœ–ã€‚

# å™ªè²é æ¸¬

![image.png](DDPM/image19.png)

å¾ä¸Šåœ–æ¨å°è‡³ä¸‹åœ–

![image.png](DDPM/image20.png)

ç›®æ¨™å°±æ˜¯å»æœ€å¤§åŒ–ï¼Œè€Œç‚ºäº†æœ€å¤§åŒ–ï¼Œä¹Ÿå°±æ˜¯ç›¡å¯èƒ½åœ°å°‡ KL Divergence æœ€å°åŒ–ã€‚ï¼ˆçœ‹å¾Œé¢çš„ï¼šKL Divergence between å‘å‰ and å‘å¾Œï¼‰

ç®—å‡º KL Divergence å‘å‰ ğ‘ ( ğ‘¥ ğ‘¡ âˆ£ ğ‘¥ ğ‘¡ âˆ’ 1 ) q(x t  âˆ£x tâˆ’1  ) èˆ‡å‘å¾Œ ğ‘ƒ ğœƒ ( ğ‘¥ ğ‘¡ âˆ£ ğ‘¥ ğ‘¡ âˆ’ 1 ) P Î¸  (x t  âˆ£x tâˆ’1  ) çš„å·®ç•°ã€‚

$\sum_{t=2}^T E_{q\left(x_t \mid x_0\right)}\left[D_{K L}\left(q\left(x_{t-1} \mid x_t, x_0\right)|| p_\theta\left(x_{t-1} \mid x_t\right)\right]\right.$

## ç®—å‡ºä¸­é–“xt-1åˆ°xtçš„åˆ†ä½ˆ q(Xt-1 | Xt, X0)

å‰é¢æˆ‘å€‘å·²ç¶“è¬›éäº†ï¼Œå¦‚ä½•ç®—å‡ºå¾ X0 åˆ° Xtï¼Œä¹ŸçŸ¥é“è¦å¦‚ä½•ç®—å‡º xt-1 åˆ° xt-1 çš„åˆ†ä½ˆã€‚

æ¨å€’å…¬å¼å¦‚ä¸‹

![image.png](DDPM/image21.png)

![image.png](DDPM/image22.png)

## KL Divergence between å‘å‰ and å‘å¾Œ

![image.png](DDPM/image23.png)

å› ç‚ºå‘å‰çš„ Mean æ˜¯ä¸å¯å‹•çš„ï¼Œæ‰€ä»¥æˆ‘å€‘å”¯ä¸€å¯å‹•çš„å°±æ˜¯ P(Xt-1|Xt) çš„ Mean ï¼Œä½¿å…©è€…é›¢ä¸­å¿ƒé»çš„è·é›¢æœ€å°ï¼Œé€™æ¨£ä¸€ä¾†ï¼Œå°±å¯ä»¥ä½¿å¾— KL Divergence ç›¡å¯èƒ½çš„å°ã€‚

![image.png](DDPM/image24.png)

æ‰€ä»¥èªªä»¥ä¸Šåœ¨åšçš„äº‹æƒ…ä¹Ÿå°±æ˜¯è¨“ç·´ denoise function ï¼Œä½¿å¾—å®ƒå€‘å…©è€…è¶Šç›¸è¿‘è¶Šå¥½ã€‚

# Sampling éšæ®µ Denoise function åŒ–ç°¡

![image.png](DDPM/image25.png)

åŸå…ˆå³ä¸Šè§’çš„å¼å­çš„ x0 å¯ä»¥æ ¹æ“šæˆ‘å€‘ä¸Šé¢å·²ç¶“å¯«å¥½é—œæ–¼ x0 å’Œ xt çš„é—œä¿‚ï¼Œåœ¨å¸¶å›å»åŒ–ç°¡ã€‚

è€Œé€™é‚Šä¹Ÿå°±å›åˆ° Algorithm Sampling éšæ®µçš„ç¬¬å››è¡Œã€‚

### Ref

[æ·±å…¥æµ…å‡ºæ‰©æ•£æ¨¡å‹(Diffusion Model)ç³»åˆ—ï¼šåŸºçŸ³DDPMï¼ˆäººäººéƒ½èƒ½çœ‹æ‡‚çš„æ•°å­¦åŸç†ç¯‡ï¼‰](https://www.cvmart.net/community/detail/7942)

[æå¼˜æ¯… DDPM](https://youtube.com/playlist?list=PLJV_el3uVTsNi7PgekEUFsyVllAJXRsP-&si=_y39Uu28junvh9re)
